<!DOCTYPE html>
<html>
<head>
    <title></title>
	<meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="../Content/Css/all.css" rel="stylesheet" />
    <link href="../Content/Css/bootstrap.min.css" rel="stylesheet" />
    <link href="../Content/Css/chat.css" rel="stylesheet" />
</head>
<body>
    <div class="page-content page-container" id="page-content">
        <div class="row container d-flex justify-content-center" style="width:100%;max-width:inherit;padding-top:2rem;">
            <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
                <div class="card card-bordered">
                    <div class="card-header">
                        <h4 class="card-title"><strong>Chat</strong></h4>
                        <a class="btn btn-xs btn-secondary" href="#" data-abc="true" id="btUsername"></a>
                    </div>
                    <div class="ps-container ps-theme-default ps-active-y" id="chat-content">
                        <div class="ps-scrollbar-x-rail" style="left: 0px; bottom: 0px;"><div class="ps-scrollbar-x" tabindex="0" style="left: 0px; width: 0px;"></div></div><div class="ps-scrollbar-y-rail" style="top: 0px; height: 0px; right: 2px;"><div class="ps-scrollbar-y" tabindex="0" style="top: 0px; height: 2px;"></div></div>
                    </div>

                    <div class="publisher bt-1 border-light">
                        <input class="publisher-input" type="text" placeholder="Write something" id="message">
                        <a class="publisher-btn text-info" href="#" data-abc="true" id="sendmessage"><i class="fa fa-paper-plane"></i></a>
                    </div>

                </div>
            </div>
        </div>
    </div>
    <script src="../Content/Scripts/jquery-1.10.2.min.js"></script>
    <script src="../Content/Scripts/bootstrap.bundle.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="../Content/Scripts/jquery.signalR-2.1.2.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="../signalr/hubs"></script>
    <!--Add script to update the page and send messages.-->
    <script src="../Content/Scripts/aes.min.js"></script>
    <script type="text/javascript">
        $(function () {
            var username = "unknown";
            var hash = window.location.search.slice(6);
            var bytes = CryptoJS.AES.decrypt(hash.toString(), 'secret key 123');
            username = bytes.toString(CryptoJS.enc.Utf8);
            $("#btUsername").text(username);
            window.scrollTo(0, document.body.scrollHeight);
            var MeNewLaunch = true;
            var HeNewLaunch = true;
            var chat = $.connection.chatHub;
            chat.client.broadcastMessage = function (name, message) {
                if (name == username)
                {
                    if (MeNewLaunch)
                    {
                        if(name !== "lav")
                            $('#chat-content').append('<div class="media media-chat media-chat-reverse"><img class="avatar" src="../Content/Images/male.png" alt="..."><div class="media-body"><p>' + message + '</p></div></div>');
                        else
                            $('#chat-content').append('<div class="media media-chat media-chat-reverse"><img class="avatar" src="../Content/Images/female.png" alt="..."><div class="media-body"><p>' + message + '</p></div></div>');
                    }
                    else
                        $('#chat-content div.media-chat-reverse:last').find('.media-body').append('<p>' + message + '</p>');
                    MeNewLaunch = false;
                    HeNewLaunch = true;
                } else
                {
                    if (HeNewLaunch)
                    {
                        if(name !== "lav")
                            $('#chat-content').append('<div class="media media-chat he-media-chat"><img class="avatar" src="../Content/Images/male.png" alt="..."><div class="media-body"><p>' + message + '</p></div></div>');
                        else
                            $('#chat-content').append('<div class="media media-chat he-media-chat"><img class="avatar" src="../Content/Images/female.png" alt="..."><div class="media-body"><p>' + message + '</p></div></div>');
                    }
                    else
                        $('#chat-content div.he-media-chat:last').find('.media-body').append('<p>' + message + '</p>');
                    MeNewLaunch = true;
                    HeNewLaunch = false;
                }
                window.scrollTo(0, document.body.scrollHeight);
            };
            $('#message').focus();
            $('#message').keydown(function (e)
            {
                if ((e.keyCode || e.which) == 13)
                {
                    e.preventDefault();
                    chat.server.send(username, $('#message').val());
                    $('#message').val('').focus();
                }
            });
            $.connection.hub.start().done(function () {
                $('#sendmessage').click(function (e) {
                    e.preventDefault();
                    chat.server.send(username, $('#message').val());
                    $('#message').val('').focus();
                });
            });
        });
    </script>
</body>
</html>
